{% extends "base.html" %}

{% block title %}{% if edit_mode %}Edytuj Trade{% else %}Dodaj Trade{% endif %} - Dziennik Tradera{% endblock %}

{% block content %}
<div class="page-header">
    <h2>{% if edit_mode %}‚úèÔ∏è Edytuj Trade{% else %}‚ûï Dodaj Nowy Trade{% endif %}</h2>
</div>

<div class="card">
    <form method="POST" action="{% if edit_mode %}/trades/{{ trade.id }}/update{% else %}/trades/create{% endif %}" id="tradeForm">
        <div class="form-grid">
            <div class="form-group status-checkboxes">
                <label>Status *</label>
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="radio" name="status" value="idea" id="status_idea" {% if edit_mode and trade.status.value == 'idea' %}checked{% endif %} required>
                        <span class="checkbox-text">Idea (Pomys≈Ç)</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="radio" name="status" value="entered" id="status_entered" {% if edit_mode and trade.status.value == 'entered' %}checked{% elif not edit_mode %}checked{% endif %} required>
                        <span class="checkbox-text">Entered (Wesz≈Çem w trade)</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="radio" name="status" value="closed" id="status_closed" {% if edit_mode and trade.status.value == 'closed' %}checked{% endif %} required>
                        <span class="checkbox-text">Closed (Zamkniƒôty)</span>
                    </label>
                </div>
            </div>

            <div class="form-group status-checkboxes">
                <label>Styl Tradingu *</label>
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="radio" name="trading_style" value="swing" {% if edit_mode and trade.trading_style.value == 'swing' %}checked{% elif not edit_mode %}checked{% endif %} required>
                        <span class="checkbox-text">Swing</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="radio" name="trading_style" value="daytrading" {% if edit_mode and trade.trading_style.value == 'daytrading' %}checked{% endif %} required>
                        <span class="checkbox-text">Daytrading</span>
                    </label>
                </div>
            </div>

            <div class="form-group status-checkboxes">
                <label>Typ Instrumentu *</label>
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="radio" name="instrument_type" value="stock" {% if edit_mode and trade.instrument_type.value == 'stock' %}checked{% elif not edit_mode %}checked{% endif %} required onchange="toggleOptionFields()">
                        <span class="checkbox-text">Stock (Akcje)</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="radio" name="instrument_type" value="option" {% if edit_mode and trade.instrument_type.value == 'option' %}checked{% endif %} required onchange="toggleOptionFields()">
                        <span class="checkbox-text">Option (Opcje)</span>
                    </label>
                </div>
            </div>

            <div class="form-group">
                <label for="ticker">Ticker *</label>
                <input type="text" name="ticker" id="ticker" value="{% if edit_mode %}{{ trade.ticker }}{% endif %}" placeholder="np. AAPL" required style="text-transform: uppercase;">
            </div>

            <div class="form-group status-checkboxes">
                <label>Kierunek *</label>
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="radio" name="direction" value="long" {% if edit_mode and trade.direction.value == 'long' %}checked{% elif not edit_mode %}checked{% endif %} required>
                        <span class="checkbox-text">Long</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="radio" name="direction" value="short" {% if edit_mode and trade.direction.value == 'short' %}checked{% endif %} required>
                        <span class="checkbox-text">Short</span>
                    </label>
                </div>
            </div>

            <div class="form-group" id="option_type_group" style="display: none;">
                <label for="option_type">Typ Opcji</label>
                <select name="option_type" id="option_type">
                    <option value="">-- Wybierz --</option>
                    <option value="CALL" {% if edit_mode and trade.option_type and trade.option_type.value == 'CALL' %}selected{% endif %}>CALL</option>
                    <option value="PUT" {% if edit_mode and trade.option_type and trade.option_type.value == 'PUT' %}selected{% endif %}>PUT</option>
                </select>
            </div>

            <div class="form-group" id="expiration_group" style="display: none;">
                <label for="expiration_date">Data Wyga≈õniƒôcia</label>
                <input type="text" name="expiration_date" id="expiration_date" value="{% if edit_mode and trade.expiration_date %}{{ trade.expiration_date }}{% endif %}" placeholder="YYYY-MM-DD">
            </div>

            <div class="form-group" id="strike_group" style="display: none;">
                <label for="strike">Strike</label>
                <input type="number" name="strike" id="strike" value="{% if edit_mode and trade.strike %}{{ trade.strike }}{% endif %}" step="0.01" placeholder="0.00">
            </div>

            <div class="form-group">
                <label for="entry_price" id="entry_price_label">Cena Wej≈õcia *</label>
                <input type="number" name="entry_price" id="entry_price" value="{% if edit_mode %}{{ trade.entry_price }}{% endif %}" step="0.01" placeholder="0.00" required>
            </div>

            <div class="form-group">
                <label for="exit_price" id="exit_price_label">Cena Wyj≈õcia</label>
                <input type="number" name="exit_price" id="exit_price" value="{% if edit_mode and trade.exit_price %}{{ trade.exit_price }}{% endif %}" step="0.01" placeholder="0.00" oninput="handleExitPriceChange()">
            </div>

            <div class="form-group">
                <label for="quantity" id="quantity_label">Ilo≈õƒá *</label>
                <input type="number" name="quantity" id="quantity" value="{% if edit_mode %}{{ trade.quantity }}{% else %}1{% endif %}" min="1" required>
            </div>

            <div class="form-group">
                <label for="fees">Prowizje</label>
                <input type="number" name="fees" id="fees" value="{% if edit_mode %}{{ trade.fees }}{% else %}0.00{% endif %}" step="0.01" placeholder="0.00">
            </div>
        </div>

        <div class="form-group">
            <label for="notes">Notatki</label>
            <textarea name="notes" id="notes" rows="4" placeholder="Twoje przemy≈õlenia, strategia, pow√≥d wej≈õcia...">{% if edit_mode and trade.notes %}{{ trade.notes }}{% endif %}</textarea>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">{% if edit_mode %}üíæ Zapisz Zmiany{% else %}‚ûï Dodaj Trade{% endif %}</button>
            {% if edit_mode %}
            <a href="/trades" class="btn btn-secondary">Anuluj</a>
            {% endif %}
        </div>
    </form>
</div>

<script>
    function toggleOptionFields() {
        const instrumentTypeRadios = document.querySelectorAll('input[name="instrument_type"]');
        let instrumentType = '';
        instrumentTypeRadios.forEach(radio => {
            if (radio.checked) {
                instrumentType = radio.value;
            }
        });
        
        const optionFields = ['option_type_group', 'expiration_group', 'strike_group'];
        const entryPriceLabel = document.getElementById('entry_price_label');
        const exitPriceLabel = document.getElementById('exit_price_label');
        const quantityLabel = document.getElementById('quantity_label');
        const entryPriceInput = document.getElementById('entry_price');
        const exitPriceInput = document.getElementById('exit_price');
        
        optionFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (instrumentType === 'option') {
                field.style.display = 'block';
            } else {
                field.style.display = 'none';
            }
        });
        
        if (instrumentType === 'option') {
            entryPriceLabel.textContent = 'Cena Kontraktu (Premium) *';
            exitPriceLabel.textContent = 'Cena Zamkniƒôcia Kontraktu';
            quantityLabel.textContent = 'Liczba Kontrakt√≥w *';
            entryPriceInput.placeholder = 'np. 2.50';
            exitPriceInput.placeholder = 'np. 3.20';
        } else {
            entryPriceLabel.textContent = 'Cena Wej≈õcia *';
            exitPriceLabel.textContent = 'Cena Wyj≈õcia';
            quantityLabel.textContent = 'Ilo≈õƒá *';
            entryPriceInput.placeholder = 'np. 150.00';
            exitPriceInput.placeholder = 'np. 155.00';
        }
    }
    
    function handleExitPriceChange() {
        const exitPriceInput = document.getElementById('exit_price');
        const statusClosedRadio = document.getElementById('status_closed');
        const statusEnteredRadio = document.getElementById('status_entered');
        
        if (exitPriceInput.value && parseFloat(exitPriceInput.value) > 0) {
            statusClosedRadio.checked = true;
        } else {
            if (statusClosedRadio.checked) {
                statusEnteredRadio.checked = true;
            }
        }
    }
    
    toggleOptionFields();
</script>
{% endblock %}
