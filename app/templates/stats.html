{% extends "base.html" %}

{% block title %}Stats - Trader Journal{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Trading Stats</h2>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <h3>Total Trades</h3>
        <div class="stat-value">{{ stats.total_trades }}</div>
        <p class="stat-label">All trades</p>
    </div>

    <div class="stat-card">
        <h3>Account Balance</h3>
        <div class="stat-value">${{ account.balance | format_decimal }}</div>
        <p class="stat-label">Starting capital</p>
    </div>

    <div class="stat-card">
        <h3>Closed Trades</h3>
        <div class="stat-value">{{ stats.closed_trades }}</div>
        <p class="stat-label">Closed positions</p>
    </div>

    <div class="stat-card">
        <h3>Open Trades</h3>
        <div class="stat-value">{{ stats.open_trades }}</div>
        <p class="stat-label">Open positions</p>
    </div>

    <div class="stat-card highlight">
        <h3>Total P&amp;L</h3>
        <div class="stat-value {% if stats.total_pnl > 0 %}positive{% elif stats.total_pnl < 0 %}negative{% endif %}">
            ${{ stats.total_pnl | format_decimal }}
        </div>
        <p class="stat-label">Net profit/loss</p>
    </div>
</div>

<div class="card">
    <h3>Portfolio Snapshot</h3>
    <div class="table-responsive">
        <table class="stats-table">
            <thead>
                <tr>
                    <th>Trader</th>
                    <th>Closed Entered Trades</th>
                    <th>P&amp;L</th>
                    <th>Portfolio Value</th>
                </tr>
            </thead>
            <tbody>
                {% for row in stats.portfolio_breakdown %}
                <tr>
                    <td>{{ row.label }}</td>
                    <td>{{ row.trades }}</td>
                    <td class="{% if row.pnl > 0 %}positive{% elif row.pnl < 0 %}negative{% endif %}">
                        ${{ row.pnl | format_decimal }}
                    </td>
                    <td>${{ row.equity | format_decimal }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <p class="help-text">Portfolio value = starting balance + entered, closed P&amp;L.</p>
</div>

<div class="stats-grid">
    <div class="stat-card success">
        <h3>Winning Trades</h3>
        <div class="stat-value">{{ stats.winning_trades }}</div>
        <p class="stat-label">Profitable trades</p>
    </div>

    <div class="stat-card danger">
        <h3>Losing Trades</h3>
        <div class="stat-value">{{ stats.losing_trades }}</div>
        <p class="stat-label">Losing trades</p>
    </div>

    <div class="stat-card highlight">
        <h3>Win Rate</h3>
        <div class="stat-value">{{ stats.winrate }}%</div>
        <p class="stat-label">Win percentage</p>
    </div>
</div>

<div class="card stats-split">
    <div class="stats-toggle">
        <button type="button" class="toggle-btn active" data-target="stockStats">Stocks</button>
        <button type="button" class="toggle-btn" data-target="optionStats">Options</button>
    </div>

    <div class="stats-scope" id="stockStats">
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Stock Trades</h3>
                <div class="stat-value">{{ stats.by_instrument.stock.total_trades }}</div>
                <p class="stat-label">All stock trades</p>
            </div>
            <div class="stat-card">
                <h3>Closed Stocks</h3>
                <div class="stat-value">{{ stats.by_instrument.stock.closed_trades }}</div>
                <p class="stat-label">Closed positions</p>
            </div>
            <div class="stat-card highlight">
                <h3>Stock P&amp;L</h3>
                <div class="stat-value {% if stats.by_instrument.stock.total_pnl > 0 %}positive{% elif stats.by_instrument.stock.total_pnl < 0 %}negative{% endif %}">
                    ${{ stats.by_instrument.stock.total_pnl | format_decimal }}
                </div>
                <p class="stat-label">Net profit/loss</p>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card success">
                <h3>Stock Winners</h3>
                <div class="stat-value">{{ stats.by_instrument.stock.winning_trades }}</div>
                <p class="stat-label">Winning trades</p>
            </div>
            <div class="stat-card danger">
                <h3>Stock Losers</h3>
                <div class="stat-value">{{ stats.by_instrument.stock.losing_trades }}</div>
                <p class="stat-label">Losing trades</p>
            </div>
            <div class="stat-card highlight">
                <h3>Stock Win Rate</h3>
                <div class="stat-value">{{ stats.by_instrument.stock.winrate }}%</div>
                <p class="stat-label">Win percentage</p>
            </div>
        </div>
    </div>

    <div class="stats-scope" id="optionStats" style="display: none;">
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Option Trades</h3>
                <div class="stat-value">{{ stats.by_instrument.option.total_trades }}</div>
                <p class="stat-label">All option trades</p>
            </div>
            <div class="stat-card">
                <h3>Closed Options</h3>
                <div class="stat-value">{{ stats.by_instrument.option.closed_trades }}</div>
                <p class="stat-label">Closed positions</p>
            </div>
            <div class="stat-card highlight">
                <h3>Option P&amp;L</h3>
                <div class="stat-value {% if stats.by_instrument.option.total_pnl > 0 %}positive{% elif stats.by_instrument.option.total_pnl < 0 %}negative{% endif %}">
                    ${{ stats.by_instrument.option.total_pnl | format_decimal }}
                </div>
                <p class="stat-label">Net profit/loss</p>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card success">
                <h3>Option Winners</h3>
                <div class="stat-value">{{ stats.by_instrument.option.winning_trades }}</div>
                <p class="stat-label">Winning trades</p>
            </div>
            <div class="stat-card danger">
                <h3>Option Losers</h3>
                <div class="stat-value">{{ stats.by_instrument.option.losing_trades }}</div>
                <p class="stat-label">Losing trades</p>
            </div>
            <div class="stat-card highlight">
                <h3>Option Win Rate</h3>
                <div class="stat-value">{{ stats.by_instrument.option.winrate }}%</div>
                <p class="stat-label">Win percentage</p>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <h3>Analysis</h3>
    <div class="analysis">
        {% if stats.closed_trades > 0 %}
            <p>
                Out of <strong>{{ stats.closed_trades }}</strong> closed trades,
                <strong>{{ stats.winning_trades }}</strong> were winners and
                <strong>{{ stats.losing_trades }}</strong> were losers.
            </p>
            <p>
                Your win rate is <strong>{{ stats.winrate }}%</strong>.
                {% if stats.winrate >= 50 %}
                    Keep the edge.
                {% else %}
                    Focus on refining your setups.
                {% endif %}
            </p>
            <p>
                Total P&amp;L:
                <strong class="{% if stats.total_pnl > 0 %}positive{% elif stats.total_pnl < 0 %}negative{% endif %}">
                    ${{ stats.total_pnl | format_decimal }}
                </strong>
            </p>
        {% else %}
            <p>No closed trades yet. Log your first trades to see analysis here.</p>
        {% endif %}
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const buttons = document.querySelectorAll('.toggle-btn');
        const scopes = document.querySelectorAll('.stats-scope');

        buttons.forEach(button => {
            button.addEventListener('click', function() {
                buttons.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');

                scopes.forEach(scope => {
                    scope.style.display = scope.id === this.dataset.target ? 'block' : 'none';
                });
            });
        });
    });
</script>
{% endblock %}
